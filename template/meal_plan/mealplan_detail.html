<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Meal Plan Details - Prep & Plate</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        /* General Styles */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f1ead1;
        }
        .navbar {
            background-color: #d14938;
            padding: 20px;
        }
        .navbar a {
            color: #f1ead1;
            font-weight: bold;
            text-decoration: none;
            padding: 0 15px;
        }
        .navbar a:hover {
            color: #efbd40;
        }
        .logout button {
            width: 100px;
            height: 40px;
            background: #f1ead0;
            border: none;
            border-radius: 5px;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-family: Georgia, serif;
            font-weight: bold;
            color: #004ead;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .logout button:hover {
            transform: scale(1.05);
        }
        h1 {
            font-family: 'Georgia', serif;
            font-weight: bold;
            text-align: center;
            color: #d14938;
            margin-bottom: 30px;
        }
        p {
            font-family: 'Poppins', sans-serif;
            color: #d14938;
        }
        strong {
            font-weight: bold;
            color: #d14938;
        }
        label {
            font-weight: bold;
            color: #d14938;
        }
        select {
            font-family: 'Poppins', sans-serif;
            border-radius: 50px;
            padding: 12px;
            background-color: #d14938;
            color: #f1ead1;
            border: none;
            width: 200px;
            margin-bottom: 10px;
        }
        input[type="date"] {
            font-family: 'Poppins', sans-serif;
            border-radius: 50px;
            padding: 12px;
            background-color: #d14938;
            color: #f1ead1;
            border: none;
            width: 200px;
            margin-bottom: 10px;
        }
        .form-label {
            font-weight: bold;
            color: #d14938;
        }
        .form-control, .form-select {
            font-family: 'Poppins', sans-serif;
            border-radius: 50px;
            padding: 12px;
            background-color: #d14938;
            color: #f1ead1;
        }
        .form-control::placeholder, .form-select::placeholder {
            font-family: 'Poppins', sans-serif;
            color: #f1ead1;
        }
        .btn-custom {
            margin-top: 40px;
            width: 300px;
            border-radius: 100px;
            background-color: #efbd40;
            color: #d14938;
            font-weight: bold;
            padding: 10px 20px;
            transition: background-color 0.3s, color 0.3s;
            border: none;
            margin-bottom: 40px;
        }
        .btn-custom:hover {
            background-color: #d14938;
            color: #efbd40;
        }
        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .recipe-grid .day {
            font-weight: bold;
            text-align: center;
            color: #d14938;
        }
        .recipe-grid .meal {
            font-weight: bold;
            text-align: center;
            color: #d14938;
        }
        .recipe-grid .recipe {
            background-color: #f1ead1;
            border: 2px solid #d14938;
            border-radius: 10px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #d14938;
        }
        .footer {
            background-color: #d14938;
            padding: 30px;
            color: #f1ead1;
            text-align: center;
            font-family: 'Poppins', sans-serif;
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1900px;
            margin-left: 40px;
            margin-right: 40px;
            flex-wrap: wrap;
        }
        .footer-left {
            flex: 1;
            text-align: left;
        }
        .footer-left img {
            width: 100px;
        }
        .footer-right {
            flex: 4;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .footer-top {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        .footer-top div {
            flex: 1;
            text-align: center;
        }
        .footer-bottom {
            margin-top: 10px;
            border-top: 2px solid #efbd40;
            padding-top: 10px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .footer-bottom a {
            color: #f1ead1;
            text-decoration: none;
            font-size: 0.9rem;
            flex: 2;
        }
        .footer-bottom a:hover {
            text-decoration: underline;
            color: #eb8917;
        }
        .checkered-divider {
            height: 20px;
            background: repeating-linear-gradient(
                45deg,
                #efbd40 0,
                #efbd40 10px,
                #f1ead0 10px,
                #f1ead0 20px
            );
        }

        table {
            background-color: #f5eacd;
            border-collapse: collapse;
            width: 100%;
            font-family: 'Poppins', sans-serif;
        }

        th, td {
            padding: 12px 15px;
            border: 2px solid #d14938;
            color: #d14938;
            text-align: center;
        }

        th {
            background-color: #efbd40;
            color: #d14938;
        }

        /* Buttons */
        .btn-info, .btn-danger, .btn-primary, .btn-warning, .btn {
            font-family: 'Poppins', sans-serif;
            border-radius: 50px;
            padding: 8px 16px;
            font-weight: bold;
            border: none;
            transition: all 0.3s ease-in-out;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-info {
            background-color: #efbd40;
            color: #d14938;
        }

        .btn-info:hover {
            background-color: #d14938;
            color: #f1ead1;
        }

        .btn-danger {
            background-color: #d14938;
            color: #f1ead1;
        }

        .btn-danger:hover {
            background-color: #a8382c;
            color: #f1ead1;
        }

        .btn-primary {
            background-color: #efbd40;
            color: #d14938;
        }

        .btn-primary:hover {
            background-color: #d14938;
            color: #f1ead1;
        }

        .btn-warning {
            background-color: #f5c364;
            color: #d14938;
        }

        .btn-warning:hover {
            background-color: #d14938;
            color: #f1ead1;
        }

        /* Hidden form toggle button */
        button[type="button"] {
            background-color: #efbd40;
            color: #d14938;
            font-family: 'Poppins', sans-serif;
            border: none;
            border-radius: 20px;
            padding: 6px 14px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 5px;
        }

        button[type="button"]:hover {
            background-color: #d14938;
            color: #f1ead1;
        }
    </style>
</head>
<body>
<nav class="navbar">
    <div class="container">
        <a href="{% url 'cookapp:home' %}">Home</a>
        <a href="{% url 'cookapp:inventory_list' %}">My Kitchen</a>
        <a href="{% url 'cookapp:grocery_list' %}">Shopping List</a>
        <a href="{% url 'cookapp:recipe_list' %}">My Recipes</a>
        <a href="{% url 'cookapp:community_pantry_list' %}">Community Pantry</a>
        <a href="{% url 'cookapp:all_recipes' %}">Browse Recipes</a>
        <a href="{% url 'cookapp:mealplan_list' %}">Meal Plan</a>
        <div class="logout">
            {% if request.user.is_authenticated %}
                <form action="{% url 'logout' %}" method="POST">
                    {% csrf_token %}
                    <button type="submit">LOGOUT</button>
                </form>
            {% else %}
                <form action="{% url 'login' %}" method="POST">
                    {% csrf_token %}
                    <button type="submit">LOGIN</button>
                </form>
            {% endif %}
        </div>
    </div>
</nav>
<!-- Main Content -->
<main class="container mt-5">

    <!-- Meal Plan Header -->
    <section class="mb-4">
        <h1>{{ mealplan.name }}</h1>
        <p><strong>Status:</strong> {{ mealplan.get_status_display }}</p>
        <p><strong>Visibility:</strong> {{ mealplan.get_visibility_display }}</p>
        <p><strong>Start Date:</strong> {{ mealplan.start_date }}</p>
        <p><strong>Created By:</strong> {{ mealplan.user.username }}</p>

        {% if mealplan.user == request.user %}
            <!-- Only show Edit and Delete buttons if the current user is the owner -->
            <a href="{% url 'cookapp:mealplan_update' mealplan.pk %}" class="btn btn-warning">Edit</a>
            <a href="{% url 'cookapp:mealplan_delete' mealplan.pk %}" class="btn btn-danger">Delete</a>
        {% endif %}
    </section>

    <!-- Recipes in Meal Plan -->
    <section class="mb-5 text-center">
        <h2 class="mb-4">Recipes in this Meal Plan</h2>
    
        {% if mealplan.meal_recipes.all %}
            <div class="table-responsive">
                <table class="table table-bordered align-middle">
                    <thead class="table-warning">
                        <tr>
                            <th>Sunday</th>
                            <th>Monday</th>
                            <th>Tuesday</th>
                            <th>Wednesday</th>
                            <th>Thursday</th>
                            <th>Friday</th>
                            <th>Saturday</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            {% for weekday in "0123456" %}
                            <td>
                                {% for meal_recipe in mealplan.meal_recipes.all %}
                                    {% if meal_recipe.scheduled_date|date:"w" == weekday %}
                                        <div class="mb-3">
                                            <strong>{{ meal_recipe.recipe.name }}</strong><br>
                                            {{ meal_recipe.scheduled_date }}
    
                                            <!-- Edit form is only visible for owners -->
                                            {% if mealplan.user == request.user %}
                                                <div class="mt-2">
                                                    <button type="button" class="btn btn-sm btn-warning" onclick="toggleEditForm('{{ meal_recipe.pk }}')">
                                                        Edit Date
                                                    </button>
                                                </div>
    
                                                <form method="POST" 
                                                      action="{% url 'cookapp:mealplan_detail' mealplan.pk %}"
                                                      id="edit-form-{{ meal_recipe.pk }}"
                                                      style="display: none; margin-top: 10px;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="meal_plan_recipe_id" value="{{ meal_recipe.pk }}">
                                                    <input type="date" id="scheduled_date_{{ meal_recipe.pk }}" 
                                                           name="scheduled_date" value="{{ meal_recipe.scheduled_date }}" required>
                                                    <button type="submit" class="btn btn-sm btn-primary mt-1">Update</button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        {% else %}
            <p>No recipes added yet.</p>
        {% endif %}
    </section>

    <!-- Add Recipe to Meal Plan -->
    {% if mealplan.user == request.user %}
    <section class="mb-5">
        <h3>Add a Recipe to This Meal Plan</h3>
        <form method="POST" action="{% url 'cookapp:recipe_add' mealplan.pk %}">
            {% csrf_token %}

            <div class="mb-3">
                <label for="recipe_id">Select Recipe:</label>
                <select id="recipe_id" name="recipe_id" required>
                    {% for recipe in recipes %}
                    <option value="{{ recipe.id }}">{{ recipe.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="scheduled_dates">Select Date(s):</label>
                <input type="date" id="scheduled_dates">
                <button type="button" id="add_date">Add Date</button>
            </div>

            <ul id="date_list" class="mb-3"></ul>
            <input type="hidden" name="scheduled_dates" id="hidden_dates">

            <button type="submit" class="btn btn-custom">Add</button>
        </form>
    </section>
    {% endif %}

    {% if mealplan.user != request.user %}
        {% if request.user in mealplan.saved_by.all %}
          
            <form method="POST" class="mt-2">
                {% csrf_token %}
                <input type="hidden" name="unsave_meal_plan" value="true">
                <button type="submit" class="btn btn-warning">Unsave This Meal Plan</button>
            </form>
        {% else %}
    
            <form method="POST" class="mt-2">
                {% csrf_token %}
                <input type="hidden" name="save_meal_plan" value="true">
                <button type="submit" class="btn btn-custom">Save This Meal Plan</button>
            </form>
        {% endif %}
    {% endif %}


    <!-- Create New Recipe -->
    <section class="mb-5">
        {% if mealplan.user == request.user %}
        <h3>Or Create a New Recipe</h3>
        <a href="{% url 'cookapp:recipe_create' mealplan.pk %}" class="btn btn-primary">Create New Recipe</a>
        {% endif %}
    </section>
</main>

<script>
function toggleEditForm(mealRecipeId) {
    let form = document.getElementById(`edit-form-${mealRecipeId}`);
    
    if (form.style.display === "none") {
        form.style.display = "block"; 
    } else {
        form.style.display = "none";  
    }
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let selectedDates = []; 
    const dateInput = document.getElementById("scheduled_dates");
    const addDateButton = document.getElementById("add_date");
    const dateList = document.getElementById("date_list");
    const hiddenDatesInput = document.getElementById("hidden_dates");

    addDateButton.addEventListener("click", function () {
        let selectedDate = dateInput.value;

        if (!selectedDate) {
            const today = new Date();
            selectedDate = today.toISOString().split("T")[0]; 
            dateInput.value = selectedDate;
        }

        if (!selectedDates.includes(selectedDate)) {
            selectedDates.push(selectedDate);

            hiddenDatesInput.value = selectedDates.join(",");

            const listItem = document.createElement("li");
            listItem.textContent = selectedDate;

            const removeButton = document.createElement("button");
            removeButton.textContent = "❌";
            removeButton.style.marginLeft = "10px";
            removeButton.onclick = function () {
                selectedDates = selectedDates.filter(date => date !== selectedDate);
                hiddenDatesInput.value = selectedDates.join(",");
                dateList.removeChild(listItem);
            };

            listItem.appendChild(removeButton);
            dateList.appendChild(listItem);
        }

        dateInput.value = "";
    });
});
</script>

</body>
</html>